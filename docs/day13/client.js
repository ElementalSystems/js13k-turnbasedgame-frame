function mk_brd(s){let l=null,o=(e,t,n,l,s)=>{for(i=0;i<5;i+=1)e.classList.toggle("l"+i,t&1<<i),e.classList.toggle("g"+i,s>=i);e.classList.toggle("p0",0==n),e.classList.toggle("p1",1==n),e.classList.toggle("ht",!!l)};let a=new Array(s.s*(s.s+2)).fill(0).map((e,t)=>{let n=clone("gamebrd","tile");return((e,t)=>{let n=t%s.s,l=Math.floor(t/s.s);l>=s.s&&(e.classList.toggle("pq"+n,!0),e.classList.toggle("pq",!0),e.style.transform="translateZ("+((n?0:10)-n*n)+"vh)",e.style.opacity=n?.5:1,l==s.s&&(n=-1.5),l==s.s+1&&(n=s.s+.5),l=t%s.s*1.1+2),e.style.left=100*n/s.s+"%",e.style.top=100*l/s.s+"%",e.style.width=e.style.height=100/s.s+"%"})(n,t),n.onclick=()=>{l&&l(t)},n}),n=null;return{setT:(e,t,n,l)=>o(a[e],t,n,l),setClk:e=>{l=e},setB:(e,t)=>{ge("gban").textContent=e,ge_gone("gban",!1),clearTimeout(n),n=setTimeout(()=>ge_gone("gban","true"),t||1e3)},flat:()=>{gecl("gamebrd","p0",!1),gecl("gamebrd","p1",!1)},update:()=>{gecl("gamebrd","p1",s.tn%2),gecl("gamebrd","p0",!(s.tn%2)),s.p.forEach((e,t)=>{ge_qs("p"+t,"h2").textContent=e.n,ge_qs("p"+t,"h3").textContent=e.sc+"%"}),a.forEach((e,t)=>{t<s.s*s.s?o(e,s.tls[t],s.own[t]):t-s.s<s.s*s.s?o(e,s.p[0].ft[t-s.s*s.s],-1):o(e,s.p[1].ft[t-s.s*s.s-s.s],-1)})}}}function selTurn(t,n,e,l,s,o){let a=t.legalM(s,e);if("l"==l.t&&(0==a.length&&o(-2),a.forEach(e=>n.setT(e,s,-1,!0)),n.setB("Select tile to crack",2e3),n.setClk(e=>o(e))),"r"==l.t&&(n.setB("Waiting for "+l.n+" to play...",6e4),lobby.waitMsg(e=>o(e.move))),"a"==l.t)if(0==a.length)o(-2);else{let e=a.map(e=>({m:e,sc:ai_eval_mv(t.gs,l,e)})).sort((e,t)=>t.sc-e.sc);setTimeout(()=>o(e[0].m),1e3+1e3*Math.random())}}function ai_eval_mv(e,t,n){var l=e.tn%2,s=1^l;let o=h_gsc(e);o.move(n);s=2*o.gs.p[l].sc-o.gs.p[s].sc;return console.log("move "+n+" val "+s+" --  "),s+Math.random()}function pubTurn(e,t,n,l,s,o){"r"==l.t&&lobby.msg({move:s})}function startGame(l){ge_gone("game",!1);let s=h_gs(l),o=mk_brd(l);o.setB("Starting Game...",3e3);let a=()=>{if(o.update(),0<=l.winner)o.setB(l.p[l.winner].n+" WON!",5e3);else{let t=l.tn%2,n=l.p[t].ft[0];o.setB(l.p[t].n+"'s turn"),selTurn(s,o,t,l.p[t],n,e=>{pubTurn(s,o,t,l.p[t?0:1],e,n),o.setClk(null),o.update(),e<0?o.setB(l.p[t].n+": Forced to discard"):(o.setB(l.p[t].n+": played"),o.setT(e,n,-1,!0)),s.move(e),o.flat(),setTimeout(a,1e3)})}};a()}function m_gs(e,t,n,l,s,o){let a=e=>(x=1&(e>>1^e>>3),y=1&(e>>0^e>>2),e^(x<<1|x<<3)^(y<<0|y<<2)),r=new Array(5).fill(l).flat().sort(()=>Math.random()-.5),g={tn:0,s:e,winner:-1,tls:new Array(e*e).fill(0),own:new Array(e*e).fill(-1),tg:new Array(e*e).fill(0),p:[{...s,ft:r},{...o,ft:r.map(e=>a(e))}]},c=h_gs(g),i=(e,t)=>{let n;for(;n=Math.floor(Math.random()*g.s*g.s),t&&(n=Math.floor(n/g.s)*g.s),!c.canPlace(n,e,t?0:-1););c.add(n,e,t?0:-1),c.add(g.s*g.s-1-n,a(e),t?1:-1)};return t&&c.add(Math.floor(g.s*g.s/2),31,-1),i(23,!0),n.forEach(e=>i(e)),g}function h_gsc(e){return h_gs({...e,tls:[...e.tls],own:[...e.own],tg:[...e.tg],p:[{...e.p[0],ft:[...e.p[0].ft]},{...e.p[1],ft:[...e.p[1].ft]}]})}function h_gs(g){let l=t=>{var e,n;0<=g.own[t]||(cq=[],e=e=>{0!=g.tls[e]&&(0<=g.own[e]?g.own[t]=g.own[e]:cq.push(e))},1&(n=g.tls[t])&&e(t-g.s),2&n&&e(t+1),4&n&&e(t+g.s),8&n&&e(t-1),0<=g.own[t]&&cq.forEach(e=>l(e)))},s=()=>{var e=g.tls.reduce((e,t)=>e+2,0),t=l=>g.tls.reduce((e,t,n)=>e+(g.own[n]==l?16&t?10:2:0),0);g.p[0].sc=Math.round(100*t(0)/e),g.p[1].sc=Math.round(100*t(1)/e),50<g.p[0].sc&&(g.winner=0),50<g.p[1].sc&&(g.winner=1),4<g.dCnt&&(g.winner=g.p[0].sc>g.p[1].sc?0:1)},n=(e,t,n)=>{g.tls[e]=t,g.own[e]=n,l(e),s()},o=(e,t,n,l,s,o)=>{var a=e%g.s+t,r=Math.floor(e/g.s)+n;if(a<0||a>=g.s||r<0||r>=g.s)return l?-10:0;r=g.tls[e+t+n*g.s];if(!r)return 0;n=g.own[e+t+n*g.s];return!(l&&n!=o&&0<=n)&&!!(r&s)==!!l?1:-10},a=(e,t,n)=>0==g.tls[e]&&0<=o(e,0,-1,1&t,4,n)+o(e,0,1,4&t,1,n)+o(e,1,0,2&t,8,n)+o(e,-1,0,8&t,2,n);return{add:n,canPlay:a,legalM:(n,l)=>g.tls.map((e,t)=>a(t,n,l)?t:-1).filter(e=>0<=e),canPlace:(e,t,n)=>0==g.tls[e]&&0<=o(e,0,-1,1&t,4,n)+o(e,0,1,4&t,1,n)+o(e,1,0,2&t,8,n)+o(e,-1,0,8&t,2,n),checkOwn:l,move:e=>{var t=g.tn%2,t=g.p[t].ft.shift();e<0?g.dCnt=1:(g.dCnt=0,n(e,t,-1)),g.tg.forEach((e,t)=>{g.own[t]<0||(g.tg[t]=Math.max(e+1,16&g.tls[t]?5:1))}),g.tn+=1,s()},gs:g}}function _init_lobby(){let n=io({upgrade:!1,transports:["websocket"]}),t=document.getElementById("board");ge("nick").value="user"+ +new Date%1e4,n.on("connect",()=>{}),n.on("lobby",e=>{t.innerHTML="",e.available.forEach(t=>{if(t.nick!=ge("nick").value){let e=clone("board","brde");e.textContent="Start Game with: "+t.nick+" - ["+t.level+"]",e.onclick=()=>{n.emit("reqstart",{opponent:t.id})}}})}),n.on("disconnect",()=>{});let l=null;n.on("gm",e=>{let t=l;l=null,t&&t(e)});let s=e=>{l=e};n.on("playstart",e=>{ge_gone("lobby",!0);var t={n:e.op,t:"r"},n={n:ge("nick").value,t:"l"};e.lead?(t=m_gs(9,!0,[23,21,26],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],n,t),o(t),console.log(t),startGame(t)):s(e=>{e.p[0].t="r",e.p[1].t="l",console.log(e),startGame(e)})}),n.on("playend",()=>{ge_gone("lobby",!1),endGame()}),n.on("error",()=>{}),geclk("enter",()=>{n.emit("el",{nick:ge("nick").value,level:ge("lev").value}),ge_no("top",!0),ge_no("bot",!1)}),geclk("leave",()=>{n.emit("ll",{}),ge_no("top",!1),ge_no("bot",!0)});let o=e=>{console.log(e),n.emit("gm",e)};return{waitMsg:s,msg:o}}var lobby=null;function start_lobby(){lobby=lobby||_init_lobby(),ge_gone("lobby",!1)}function init(){startGame(m_gs(7,!0,[19],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],{n:"Player 1",t:"l"},{n:"I. Diot",t:"a"}))}let ge=e=>document.getElementById(e),gecl=(e,t,n)=>ge(e).classList.toggle(t,n),geclk=(e,t)=>ge(e).onclick=t,ge_gone=(e,t)=>gecl(e,"gone",t),ge_no=(e,t)=>gecl(e,"no",t),clone=(e,t)=>{t=document.querySelector("#"+t).content.firstElementChild.cloneNode(!0);return ge(e).appendChild(t),t},ge_qs=(e,t)=>ge(e).querySelector(t);