var _audC=new(window.AudioContext||window.webkitAudioContext),_aud_MV=1;function tone(t,e){if(!_audC||!_aud_MV)return{f:function(){return this},v:function(){return this}};var n=_audC.currentTime,l=_audC.createOscillator(),a=_audC.createGain();return e&&(l.type=e),l.frequency.value=0,a.gain.value=0,l.connect(a),a.connect(_audC.destination),l.start(0),l.stop(n+t),{f:function(){if(1==arguments.length)return l.frequency.value=arguments[0],this;for(var e=0;e<arguments.length;e+=1)l.frequency.linearRampToValueAtTime(arguments[e],n+e/(arguments.length-1)*t);return this},v:function(){if(1==arguments.length)return a.gain.value=arguments[0]*_aud_MV,this;for(var e=0;e<arguments.length;e+=1)a.gain.linearRampToValueAtTime(arguments[e]*_aud_MV,n+e/(arguments.length-1)*t);return this}}}var ae={clk:()=>{tone(.2,"triangle").f(200,220,200).v(.1,.3,0),tone(.2,"triangle").f(220,200,220).v(.3,.1,0)},bounce:()=>{tone(.33).f(420,440).v(.1,.3,.3,.3,.2,.1,0)},rising:()=>{tone(2).f(100,440).v(.1,.3,.1,.3,.1,.5,.6,0)},crack:()=>{tone(.1,"square").f(220,120,100).v(.5,.6,.3),tone(.15,"square").f(120,80,100).v(.2,.3,.5,.3)},worble:()=>{tone(1).f(150,220,150,250,150).v(.1,.2,.1,.2,.1,.2,.1,.2,0)},death:()=>{tone(2).f(100,300,100,300).v(.3,.5,.1,0),tone(2).f(200,100,200,100).v(.1,.2,.5,0)},weird:()=>{tone(3).f(120,420).v(0,.3),tone(3).f(220,420).v(0,.3),tone(3).f(320,420).v(0,.3)}};function mk_brd(o){let l=null,a=(e,t,n,l,a)=>{for(e.classList.toggle("ub",0==t),e.classList.toggle("p0",0==n),e.classList.toggle("p1",1==n),e.classList.toggle("ht",!!l),i=0;i<5;i+=1)e.classList.toggle("l"+i,t&1<<i);if(0<a&&!e.g_lev){for(i=0;i<5;i+=1)t&1<<i&&(4==i?cloneM(e,"llev",4,"xx","ll").forEach((e,t)=>{let n=e.querySelector("svg");n.style.transform="rotateZ("+(90*t+30*Math.random()-15)+"deg) rotateX(-90deg)",cloneM(e,"leaf",5,"p","hl").forEach((e,t)=>{e.style.transform="translateZ("+50*Math.random()/o.s+"vh) rotateZ("+360*Math.random()+"deg)"})}):cloneM(e,"leaf",3,"p","l"+i).forEach(e=>{let t=e.querySelector("svg");t.style.transform="translateY("+40*-Math.random()+"%) rotateZ("+(90*Math.random()-45)+"deg) rotateX("+(45*-Math.random()-10)+"deg)"}));e.g_lev=a}setTimeout(()=>{for(i=0;i<6;i+=1)e.classList.toggle("g"+i,a>=i)},10)},r=(e,t)=>{let n=t%o.s,l=Math.floor(t/o.s);return l>=o.s&&(e.classList.toggle("pq",!0),e.classList.toggle("pq"+(l>o.s?"1":"0"),!0),e.style.transform="translateZ("+((n?2:120/o.s)-n)+"vh)",e.style.opacity=n?.5:1,l==o.s&&(n=-1.2),l==o.s+1&&(n=o.s+.2),l=t%o.s*1.1+2),t<0&&(n=o.s/2,l=20),e.style.left=100*n/o.s+"%",e.style.top=100*l/o.s+"%",e.style.width=e.style.height=100/o.s+"%",e};ge("gamebrd").innerHTML="";let s=new Array(o.s*(o.s+2)).fill(0).map((e,t)=>{let n=clone("gamebrd","tile");return n.style.transform="rotateY("+(4*Math.random()-2)+"deg) rotateX("+(4*Math.random()-2)+"deg) rotateZ("+(4*Math.random()-2)+"deg)",cloneM(n,["crack1","crack2"],4,"l","ex"),r(n,t),n.onclick=()=>{l&&l(t)},n}),n=null;return{setT:(e,t,n,l)=>a(s[e],t,n,l),setClk:e=>{l=e},setB:(e,t)=>{ge("gban").textContent=e,ge_gone("gban",!1),clearTimeout(n),n=setTimeout(()=>ge_gone("gban","true"),t||1e3)},flat:e=>{gecl("game","p1",e&&o.tn%2),gecl("game","p0",e&&!(o.tn%2))},update:()=>{o.p.forEach((e,t)=>{ge_qs("p"+t,"h2").textContent=e.n,ge_qs("p"+t,"h3").textContent=e.sc+"%"}),s.forEach((e,t)=>{r(e,t),t<o.s*o.s?a(e,o.tls[t],o.own[t],!1,o.tg[t]):t-o.s<o.s*o.s?a(e,o.p[0].ft[t-o.s*o.s],-1):a(e,o.p[1].ft[t-o.s*o.s-o.s],-1)})},animateM:(e,t)=>{let n=o.s*(o.s+e);gecl("gamebrd","slow",!0);for(let e=0;e<o.s;e+=1)r(s[n+e],0==e?t:n+e-1);setTimeout(()=>{s[n].style.transform="translateZ(.5vh)",setTimeout(()=>gecl("gamebrd","slow",!1),1e3)},1e3)}}}function selTurnSoon(e,t,n,l,a,o){setTimeout(()=>selTurn(e,t,n,l,a,o),1e3)}function selTurn(t,n,e,l,a,o){let r=t.legalM(a,e);if("l"==l.t){if(0==r.length)return void o(-2);n.setClk(e=>o(e)),r.forEach(e=>n.setT(e,a,-1,!0)),n.setB("Select tile to crack",2e3),n.setClk(e=>o(e))}if("r"==l.t&&(n.setB("Waiting for "+l.n+" to play...",6e4),lobby.waitMsg(e=>o(e.move))),"a"==l.t)if(0==r.length)o(-2);else{let e=r.map(e=>({m:e,sc:ai_eval_mv(t.gs,l,e)})).sort((e,t)=>t.sc-e.sc);setTimeout(()=>o(e[0].m),1e3+1e3*Math.random())}}function ai_eval_mv(e,t,n){var l=e.tn%2,a=1^l;let o=h_gsc(e);o.move(n);let r=2*o.gs.p[l].tsc-o.gs.p[a].tsc;return e.winner==l&&(r+=1e4),e.winner==a&&(r-=1e4),r+Math.random()}function pubTurn(e,t,n,l,a,o){"r"==l.t&&lobby.msg({move:a})}function startGame(l){document.body.classList.toggle("ms",!1);let a=h_gs(l),o=mk_brd(l);o.setB("Starting Game...",3e3);let r=()=>{o.flat(!1),o.update(),setTimeout(()=>{if(0<=l.winner)return o.setB(l.p[l.winner].n+" WON!",5e4),void setTimeout(()=>{lobby.gamedone()},5e3);o.flat(!0);let t=l.tn%2,n=l.p[t].ft[0];o.setB(l.p[t].n+"'s turn"),selTurnSoon(a,o,t,l.p[t],n,e=>{pubTurn(a,o,t,l.p[t?0:1],e,n),o.setClk(null),o.flat(!1),o.update(),e<0?o.setB(l.p[t].n+"was forced to discard ("+(l.dCnt+1)+")"):o.setB(l.p[t].n+" played"),o.animateM(t,e),a.move(e),setTimeout(r,2e3)})},3e3)};r()}function startGameD(e,t,n){startGame(m_gs(e.bs,e.bs%2,e.it,e.dt,t,n))}function m_gs(e,t,n,l,a,o){let r=e=>(x=1&(e>>1^e>>3),y=1&(e>>0^e>>2),e^(x<<1|x<<3)^(y<<0|y<<2)),s=new Array(5).fill(l).flat().sort(()=>Math.random()-.5),i={tn:0,s:e,winner:-1,tls:new Array(e*e).fill(0),own:new Array(e*e).fill(-1),tg:new Array(e*e).fill(0),p:[{...a,ft:s},{...o,ft:s.map(e=>r(e))}]},c=h_gs(i);return t&&c.add(Math.floor(i.s*i.s/2),31,-1,-1),n.forEach((e,t)=>((e,t)=>{let n;for(;n=Math.floor(Math.random()*i.s*i.s),t&&(n=Math.floor(n/i.s)*i.s),!c.canPlace(n,e,t?0:-1););c.add(n,e,t?0:-1,-1),c.add(i.s*i.s-1-n,r(e),t?1:-1,-1)})(e,0==t)),i}function h_gsc(e){return h_gs({...e,tls:[...e.tls],own:[...e.own],tg:[...e.tg],p:[{...e.p[0],ft:[...e.p[0].ft]},{...e.p[1],ft:[...e.p[1].ft]}]})}function h_gs(a){let o=(t,n)=>{0<=a.own[t]||(a.own[t]=i(t,a.tls[t],n),0<=a.own[t]&&[0,1,2,3].forEach(e=>{e=s(t,e).i;0<=e&&o(e,n)}))},r=()=>{var e=a.s*a.s*2,t=l=>a.tls.reduce((e,t,n)=>e+(a.own[n]==l?a.tg[n]:0),0),n=l=>a.tls.reduce((e,t,n)=>e+(a.own[n]==l?16&t?5:2:0),0);a.p[0].sc=Math.round(100*t(0)/e),a.p[1].sc=Math.round(100*t(1)/e),a.p[0].tsc=Math.round(100*n(0)/e),a.p[1].tsc=Math.round(100*n(1)/e),50<a.p[0].sc&&(a.winner=0),50<a.p[1].sc&&(a.winner=1),4<a.dCnt&&(a.winner=a.p[0].sc>a.p[1].sc?0:1)},l=(e,t,n,l)=>{a.tls[e]=t,-1!=(a.own[e]=n)&&(a.tg[e]=1),o(e,l),r()},s=(e,t)=>{var n=e%a.s+[0,1,0,-1][t],t=Math.floor(e/a.s)+[-1,0,1,0][t];if(n<0||n>=a.s||t<0||t>=a.s)return{t:0,o:-1,i:-1};n=t*a.s+n;return{i:n,t:a.tls[n],o:a.own[n]}},i=(l,a,e)=>{let t=[0,1,2,3].map(e=>{var t=1<<e,n=1<<(e+2)%4,e=s(l,e);return 0==e.t?-2:-1==a?e.t&n?e.o:-1:0<e.t&&!!(e.t&n)!=!!(a&t)?-999:a&t?e.o:-1});return console.log(t,e),t.includes(-999)?-999:t.includes(e)?e:t.includes(1^e)?1^e:-1},c=(e,t,n)=>0==a.tls[e]&&[-1,-2,n].includes(i(e,t,n));return{add:l,canPlay:c,legalM:(n,l)=>a.tls.map((e,t)=>c(t,n,l)?t:-1).filter(e=>0<=e),canPlace:(e,t,n)=>0==a.tls[e]&&[-1,-2,n].includes(i(e,t,n)),move:e=>{var t=a.tn%2,n=a.p[t].ft.shift();e<0?a.dCnt+=1:(a.dCnt=0,l(e,n,-1,t)),a.tn+=1,a.tg.forEach((e,t)=>{a.own[t]<0||(a.tg[t]=Math.min(e+1,16&a.tls[t]?5:2))}),r()},gs:a,playOutcome:i}}function _init_lobby(){let l=null,n=null,a=e=>{n=e},o=null;try{o=io({upgrade:!1,transports:["websocket"]}),o.on("connect",()=>{}),o.on("lobby",e=>{e=e.available.filter(e=>e.nick!=ge("nick").value).map(e=>({t:"Play with "+e.nick,lt:e.level,u:e,em:"ðŸ”—"}));menu("Player vs Player Online: Select Opponent",!0,e,(e,t)=>{o.emit("reqstart",{opponent:e.u.id})})}),o.on("disconnect",()=>{}),o.on("gm",e=>{let t=n;n=null,t&&t(e)}),o.on("playstart",e=>{var t={n:e.op,t:"r"},n={n:ge("nick").value,t:"l"};e.lead?(t=m_gs(l.bs,l.bs%2,l.it,l.dt,n,t),r(t),startGame(t)):a(e=>{e.p[0].t="r",e.p[1].t="l",startGame(e)})}),o.on("playend",()=>{gamedone()}),o.on("error",()=>{})}catch(e){}let r=e=>{o.emit("gm",e)};geclk("bck",()=>{ae.crack(),leave_mp()}),menu=(e,t,n,l)=>{ge("menu").innerHTML="",ge_qs("bot","legend").textContent=e,n.forEach((e,t)=>{let n=clone("menu","menui");qs_txt(n,"h1",e.em),qs_txt(n,"h2",e.t),qs_txt(n,"h3",e.lt),n.onclick=()=>{ae.clk(),l(e,t)}}),ge_gone("bck",!t)};let s=e=>{l=e,o.emit("el",{nick:ge("nick").value,level:e.t}),ge_no("top",!0)};return leave_mp=()=>{l&&o.emit("ll",{}),l=null,reset()},gamedone=()=>{l&&o.emit("reqend"),document.body.classList.toggle("ms",!0)},reset=()=>{document.body.classList.toggle("ms",!0),ge_gone("top",!1),menu("Select Game Type",!1,m_main,(e,t)=>{switch(t){case 1:menu("Player vs Computer: Board Type",!0,m_gt,(n,e)=>{menu("Player vs Computer: Opponent",!0,m_ais,(e,t)=>{p1={n:ge("nick").value,t:"l"},p2={n:e.t,t:"a"},startGameD(n,p1,p2)})});break;case 2:menu("Player vs Player Local: Board Type",!0,m_gt,(e,t)=>{p1={n:ge("nick").value,t:"l"},p2={n:"Player 2",t:"l"},startGameD(e,p1,p2)});break;case 3:menu("Player vs Player Online: Board Type",!0,m_gt,(e,t)=>{s(e)})}})},{waitMsg:a,msg:r,menu:menu,enter_mp:s,reset:reset,gamedone:gamedone}}var lobby=null;function start_lobby(){lobby=lobby||_init_lobby(),ge("nick").value="user"+ +new Date%1e4,lobby.menu("Welcome to A Space in the Sun",!1,[{t:"START GROWING",lt:"Tap here to begin",em:""}],()=>{lobby.reset()})}function init(){m_gs(6,!1,[7,20,22],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],{n:"Player 1",t:"l"},{n:"I. Diot",t:"l"});start_lobby()}let m_main=[{t:"Learn to Play",em:"ðŸŽ“",lt:"Quick tutorials to learn to play"},{t:"Play vs Computer",em:"ðŸ’»",lt:"Play against various AI opponents"},{t:"Player vs Local Player",em:"ðŸŽŽ",lt:"Play against a friend on one device"},{t:"Player vs Online Player",em:"ðŸ”—",lt:"Play against a human online"}],m_ais=[{t:"I.Diot",em:"ðŸ’»",lt:"Not very good"},{t:"Defensive",em:"ðŸ’»",lt:"Not very good"},{t:"Geni Use",em:"ðŸ’»",lt:"Not very good"}],m_gt=[{t:"7 x 7 Beginners Board",em:"ðŸŽª",bs:7,it:[7,19],dt:[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],lt:"Small board for a quick game"},{t:"9 x 9 Standard Board",bs:9,em:"ðŸ¥‹",lt:"Standard symetric starting",it:[23,21,26,19],dt:[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5]},{t:"6 x 6 Expert Fast Kill",bs:6,em:"ðŸŽ¯",lt:"Fast and tight quick game",it:[7,20,22],dt:[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5]}],ge=e=>document.getElementById(e),gecl=(e,t,n)=>ge(e).classList.toggle(t,n),geclk=(e,t)=>ge(e).onclick=t,ge_gone=(e,t)=>gecl(e,"gone",t),ge_no=(e,t)=>gecl(e,"no",t),cloneIn=(e,t,n)=>{n=document.querySelector("#"+t).content.querySelector(n).cloneNode(!0);return e.appendChild(n),n},clone=(e,t)=>cloneIn(ge(e),t,"*"),ge_qs=(e,t)=>ge(e).querySelector(t),qs_txt=(e,t,n)=>e.querySelector(t).textContent=n,oneof=e=>Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:e,cloneM=(l,a,e,o,r)=>new Array(e).fill(0).map((e,t)=>{let n=cloneIn(l,oneof(a),"*");return n.classList.toggle(o+t,!0),n.classList.toggle(r,!0),n});