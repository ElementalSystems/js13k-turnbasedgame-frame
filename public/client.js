function mk_brd(o){let l=null,s=(e,t,n,l)=>{for(i=0;i<5;i+=1)e.classList.toggle("l"+i,t&1<<i);e.classList.toggle("p0",0==n),e.classList.toggle("p1",1==n),e.classList.toggle("ht",!!l)};let a=new Array(o.s*(o.s+2)).fill(0).map((e,t)=>{let n=clone("gamebrd","tile");return((e,t)=>{let n=t%o.s,l=Math.floor(t/o.s);l==o.s&&(n=-1.5),l==o.s+1&&(n=o.s+.5),l>=o.s&&(l=t%o.s*1.2+.3),e.style.left=100*n/o.s+"%",e.style.top=100*l/o.s+"%",e.style.width=e.style.height=100/o.s+"%"})(n,t),n.onclick=()=>{l&&l(t)},n});return{setT:(e,t,n,l)=>s(a[e],t,n,l),setClk:e=>{l=e},setB:(e,t)=>{ge("gban").textContent=e,ge_gone("gban",!1),setTimeout(()=>ge_gone("gban","true"),t||1e3)},flat:()=>{gecl("gamebrd","p0",!1),gecl("gamebrd","p1",!1)},update:()=>{gecl("gamebrd","p1",o.tn%2),gecl("gamebrd","p0",!(o.tn%2)),o.p.forEach((e,t)=>{ge_qs("p"+t,"h2").textContent=e.n,ge_qs("p"+t,"h3").textContent=e.sc+"%"}),a.forEach((e,t)=>{t<o.s*o.s?s(e,o.tls[t],o.own[t]):t-o.s<o.s*o.s?s(e,o.p[0].ft[t-o.s*o.s],-1):s(e,o.p[1].ft[t-o.s*o.s-o.s],-1)})}}}function selTurn(e,t,n,l,o,s){let a=e.legalM(o,n);"l"==l.t&&(0==a.length&&s(-2),a.forEach(e=>t.setT(e,o,-1,!0)),t.setClk(e=>s(e))),"r"==l.t&&(console.log("waiting for next turn"),lobby.waitMsg(e=>s(e.move)))}function pubTurn(e,t,n,l,o,s){"r"==l.t&&lobby.msg({move:o})}let isLead=0;function startGameMulti(e,t,n){let l=document.getElementById("game");l.classList.toggle("gone",!1),isLead=e?1:0,e&&(gameState.turn=1,gameState.initTime=+new Date,t(gameState),updateBoard())}function msgGame(e){}function endGame(){}function updateBoard(){}function startGame(l){ge_gone("game",!1);let o=h_gs(l),s=mk_brd(l);s.setB("Starting Game...",3e3);let a=()=>{if(s.update(),0<=l.winner)s.setB(l.p[l.winner].n+" WON!",5e3);else{let t=l.tn%2,n=l.p[t].ft[0];s.setB(l.p[t].n+"'s turn"),selTurn(o,s,t,l.p[t],n,e=>{pubTurn(o,s,t,l.p[t?0:1],e,n),s.setClk(null),s.update(),e<0?(s.setB(l.p[t].n+": Forced to Discarded"),l.dCnt=1):(l.dCnt=0,s.setB(l.p[t].n+": played"),s.setT(e,n,-1,!0),o.add(e,n,-1)),l.tn+=1,l.p[t].ft.shift(),s.flat(),setTimeout(a,1e3)})}};a()}function m_gs(e,t,n,l,o,s){let a=e=>(x=1&(e>>1^e>>3),y=1&(e>>0^e>>2),e^(x<<1|x<<3)^(y<<0|y<<2)),r=new Array(5).fill(l).flat().sort(()=>Math.random()-.5),g={tn:0,s:e,winner:-1,tls:new Array(e*e).fill(0),own:new Array(e*e).fill(-1),p:[{...o,ft:r},{...s,ft:r.map(e=>a(e))}]},c=h_gs(g),i=(e,t)=>{let n;for(;n=Math.floor(Math.random()*g.s*g.s),t&&(n=Math.floor(n/g.s)*g.s),!c.canPlace(n,e,t?0:-1););c.add(n,e,t?0:-1),c.add(g.s*g.s-1-n,a(e),t?1:-1)};return t&&c.add(Math.floor(g.s*g.s/2),31,-1),i(23,!0),n.forEach(e=>i(e)),g}function h_gs(g){let l=t=>{var e,n;0<=g.own[t]||(cq=[],e=e=>{0!=g.tls[e]&&(0<=g.own[e]?g.own[t]=g.own[e]:cq.push(e))},1&(n=g.tls[t])&&e(t-g.s),2&n&&e(t+1),4&n&&e(t+g.s),8&n&&e(t-1),0<=g.own[t]&&cq.forEach(e=>l(e)))};let o=(e,t,n,l,o,s)=>{var a=e%g.s+t,r=Math.floor(e/g.s)+n;if(a<0||a>=g.s||r<0||r>=g.s)return l?-10:0;r=g.tls[e+t+n*g.s];if(!r)return 0;n=g.own[e+t+n*g.s];return!(l&&n!=s&&0<=n)&&!!(r&o)==!!l?1:-10},s=(e,t,n)=>0==g.tls[e]&&0<=o(e,0,-1,1&t,4,n)+o(e,0,1,4&t,1,n)+o(e,1,0,2&t,8,n)+o(e,-1,0,8&t,2,n);return{add:(e,t,n)=>{g.tls[e]=t,g.own[e]=n,l(e),n=g.tls.reduce((e,t)=>e+2,0),e=l=>g.tls.reduce((e,t,n)=>e+(g.own[n]==l?16&t?10:2:0),0),g.p[0].sc=Math.round(100*e(0)/n),g.p[1].sc=Math.round(100*e(1)/n),50<g.p[0].sc&&(g.winner=0),50<g.p[1].sc&&(g.winner=1),4<g.dCnt&&(g.winner=g.p[0].sc>g.p[1].sc?0:1)},canPlay:s,legalM:(n,l)=>g.tls.map((e,t)=>s(t,n,l)?t:-1).filter(e=>0<=e),canPlace:(e,t,n)=>0==g.tls[e]&&0<=o(e,0,-1,1&t,4,n)+o(e,0,1,4&t,1,n)+o(e,1,0,2&t,8,n)+o(e,-1,0,8&t,2,n),checkOwn:l,gs:g}}function _init_lobby(){let n=io({upgrade:!1,transports:["websocket"]}),t=document.getElementById("board");ge("nick").value="user"+ +new Date%1e4,n.on("connect",()=>{}),n.on("lobby",e=>{t.innerHTML="",e.available.forEach(t=>{if(t.nick!=ge("nick").value){let e=clone("board","brde");e.textContent="Start Game with: "+t.nick+" - ["+t.level+"]",e.onclick=()=>{n.emit("reqstart",{opponent:t.id})}}})}),n.on("disconnect",()=>{});let l=null;n.on("gm",e=>{let t=l;l=null,t&&t(e)});let o=e=>{l=e};n.on("playstart",e=>{ge_gone("lobby",!0);var t={n:e.op,t:"r"},n={n:ge("nick").value,t:"l"};e.lead?(t=m_gs(9,!0,[23,21,26],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],n,t),s(t),console.log(t),startGame(t)):o(e=>{e.p[0].t="r",e.p[1].t="l",console.log(e),startGame(e)})}),n.on("playend",()=>{ge_gone("lobby",!1),endGame()}),n.on("error",()=>{}),geclk("enter",()=>{n.emit("el",{nick:ge("nick").value,level:ge("lev").value}),ge_no("top",!0),ge_no("bot",!1)}),geclk("leave",()=>{n.emit("ll",{}),ge_no("top",!1),ge_no("bot",!0)});let s=e=>{console.log(e),n.emit("gm",e)};return{waitMsg:o,msg:s}}var lobby=null;function start_lobby(){lobby=lobby||_init_lobby(),ge_gone("lobby",!1)}function init(){m_gs(9,!0,[23,21,26],[3,6,12,5,11,7,5,10,14,15,15,13,3,6,9,12,7,5],{n:"andrew",t:"l"},{n:"Brilly Ant",t:"l"});start_lobby()}let ge=e=>document.getElementById(e),gecl=(e,t,n)=>ge(e).classList.toggle(t,n),geclk=(e,t)=>ge(e).onclick=t,ge_gone=(e,t)=>gecl(e,"gone",t),ge_no=(e,t)=>gecl(e,"no",t),clone=(e,t)=>{t=document.querySelector("#"+t).content.firstElementChild.cloneNode(!0);return ge(e).appendChild(t),t},ge_qs=(e,t)=>ge(e).querySelector(t);